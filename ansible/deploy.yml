---
- name: Deploy Event Management System to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    k8s_namespace: default
    kubeconfig_path: "{{ ansible_env.HOME }}/.kube/config"
    k8s_manifests_dir: "../k8s"
    
  tasks:
    - name: Check if kubectl is installed
      command: which kubectl
      register: kubectl_check
      ignore_errors: true
      changed_when: false
      
    - name: Install kubectl if not present
      block:
        - name: Download kubectl binary
          get_url:
            url: "https://dl.k8s.io/release/v1.28.0/bin/linux/amd64/kubectl"
            dest: "/tmp/kubectl"
            mode: '0755'
            
        - name: Move kubectl to /usr/local/bin
          become: true
          copy:
            src: "/tmp/kubectl"
            dest: "/usr/local/bin/kubectl"
            mode: '0755'
            remote_src: true
            
        - name: Verify kubectl installation
          command: kubectl version --client
          changed_when: false
      when: kubectl_check.rc != 0
      
    - name: Verify kubeconfig exists
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat
      
    - name: Fail if kubeconfig not found
      fail:
        msg: "Kubeconfig not found at {{ kubeconfig_path }}. Please ensure kubectl is configured."
      when: not kubeconfig_stat.stat.exists
      
    - name: Test kubectl connectivity
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
        kubeconfig: "{{ kubeconfig_path }}"
      register: cluster_info
      
    - name: Display cluster information
      debug:
        msg: "Connected to Kubernetes cluster with {{ cluster_info.resources | length }} nodes"
        
    - name: Find all Kubernetes manifest files
      find:
        paths: "{{ k8s_manifests_dir }}"
        patterns: "*.yaml,*.yml"
        file_type: file
      register: k8s_files
      delegate_to: localhost
      
    - name: Display found manifest files
      debug:
        msg: "Found {{ k8s_files.files | length }} Kubernetes manifest files"
        
    - name: Apply secrets first
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/secrets.yaml"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ k8s_namespace }}"
      tags: secrets
      
    - name: Apply PVC for MySQL
      kubernetes.core.k8s:
        state: present
        src: "{{ k8s_manifests_dir }}/mysql-pvc.yaml"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ k8s_namespace }}"
      tags: storage
      
    - name: Apply MySQL deployment and service
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ k8s_namespace }}"
        wait: true
        wait_timeout: 300
      loop:
        - "{{ k8s_manifests_dir }}/mysql-deployment.yaml"
        - "{{ k8s_manifests_dir }}/mysql-service.yaml"
      tags: mysql
      
    - name: Wait for MySQL to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: mysql-deployment
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300
      tags: mysql
      
    - name: Apply backend deployment and service
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ k8s_namespace }}"
        wait: true
        wait_timeout: 300
      loop:
        - "{{ k8s_manifests_dir }}/simple-backend-deployment.yaml"
        - "{{ k8s_manifests_dir }}/simple-backend-service.yaml"
      tags: backend
      
    - name: Wait for backend to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: simple-backend-deployment
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300
      tags: backend
      
    - name: Apply frontend deployment and service
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ k8s_namespace }}"
        wait: true
        wait_timeout: 300
      loop:
        - "{{ k8s_manifests_dir }}/deployment-frontend.yaml"
        - "{{ k8s_manifests_dir }}/service-frontend.yaml"
      tags: frontend
      
    - name: Wait for frontend to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: frontend-deployment
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300
      tags: frontend
      
    - name: Get deployment status
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: deployments
      
    - name: Get service status
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: services
      
    - name: Get pod status
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ k8s_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: pods
      
    - name: Display deployment summary
      debug:
        msg: |
          Deployment Summary:
          ===================
          Deployments: {{ deployments.resources | length }}
          Services: {{ services.resources | length }}
          Pods: {{ pods.resources | length }}
          
          Frontend Service External IP: {{ (services.resources | selectattr('metadata.name', 'equalto', 'frontend-service') | first).status.loadBalancer.ingress[0].ip | default('Pending') }}
          
    - name: Show next steps
      debug:
        msg: |
          Deployment completed successfully!
          
          Next steps:
          1. Check the frontend service external IP: kubectl get service frontend-service
          2. Access your application at: http://<EXTERNAL-IP>
          3. Monitor pods: kubectl get pods
          4. Check logs: kubectl logs -l app=frontend or kubectl logs -l app=backend
